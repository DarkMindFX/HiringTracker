

SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

IF OBJECT_ID('p_{Entity}_Upsert', 'P') IS NOT NULL
DROP PROC [dbo].[p_{Entity}_Upsert]
GO

CREATE PROCEDURE [dbo].[p_{Entity}_Upsert]
	{PARAMS_UPSERT_LIST}
AS
BEGIN

	SET NOCOUNT ON;

	DECLARE @ItemID AS BIGINT

    IF(@ID IS NULL)
	BEGIN
		INSERT INTO [dbo].[{Entity}]
		SELECT {UPSERT_INSERT_VALUES_LIST}

		SET @ID = @@IDENTITY

	END
	ELSE
	BEGIN
		
		IF(EXISTS(SELECT 1 FROM dbo.{Entity} WHERE {WHERE_PK_LIST}))
		BEGIN
			UPDATE [dbo].[{Entity}]
			SET
				{UPSERT_UPDATE_VALUES_LIST}
			WHERE	
				{WHERE_PK_LIST}


			SELECT @ItemID = @ID FROM dbo.{Entity} WHERE {WHERE_PK_LIST}

 		END
		ELSE
		BEGIN
			THROW 51001, '{Entity} was not found', 1;
		END		
	END

	SELECT
		e.*
	FROM
		[dbo].[{Entity}] e
	WHERE
		{WHERE_PK_LIST}
END
GO